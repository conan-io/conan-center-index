diff --git a/CMakeLists.txt b/CMakeLists.txt
index 9fa1e11..fb11d50 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -887,8 +887,10 @@ ENDIF(NOT OPENSSL_FOUND)
 # required libraries.
 #
 MACRO(CHECK_CRYPTO ALGORITHMS IMPLEMENTATION)
+    include(CMakePushCheckState)
     FOREACH(ALGORITHM ${ALGORITHMS})
       IF(NOT ARCHIVE_CRYPTO_${ALGORITHM})
+      cmake_push_check_state()
       STRING(TOLOWER "${ALGORITHM}" lower_algorithm)
       STRING(TOUPPER "${ALGORITHM}" algorithm)
       IF ("${IMPLEMENTATION}" MATCHES "^OPENSSL$" AND NOT OPENSSL_FOUND)
@@ -908,8 +910,9 @@ MACRO(CHECK_CRYPTO ALGORITHMS IMPLEMENTATION)
 	IF ("${IMPLEMENTATION}" MATCHES "^OPENSSL$" AND OPENSSL_FOUND)
 	    SET(TRY_CRYPTO_REQUIRED_INCLUDES
 	      "${TRY_CRYPTO_REQUIRED_INCLUDES};${OPENSSL_INCLUDE_DIR}")
-	    SET(TRY_CRYPTO_REQUIRED_LIBS
-	        "-DLINK_LIBRARIES:STRING=${OPENSSL_LIBRARIES}")
+	    #SET(TRY_CRYPTO_REQUIRED_LIBS
+	    #    "-DLINK_LIBRARIES:STRING=${OPENSSL_LIBRARIES}")
+	    SET(CMAKE_REQUIRED_LIBRARIES ${OPENSSL_LIBRARIES})
 	ELSEIF("${IMPLEMENTATION}" MATCHES "^MBEDTLS$" AND MBEDTLS_FOUND)
 	    SET(TRY_CRYPTO_REQUIRED_INCLUDES
 	      "${TRY_CRYPTO_REQUIRED_INCLUDES};${MBEDTLS_INCLUDE_DIRS}")
@@ -921,8 +924,7 @@ MACRO(CHECK_CRYPTO ALGORITHMS IMPLEMENTATION)
 	    SET(TRY_CRYPTO_REQUIRED_LIBS
 	        "-DLINK_LIBRARIES:STRING=${NETTLE_LIBRARY}")
 	ELSEIF("${IMPLEMENTATION}" MATCHES "^LIBMD$" AND LIBMD_FOUND)
-	    SET(TRY_CRYPTO_REQUIRED_LIBS
-	        "-DLINK_LIBRARIES:STRING=${LIBMD_LIBRARY}")
+      SET(CMAKE_REQUIRED_LIBRARIES ${OPENSSL_LIBRARIES})
 	ENDIF("${IMPLEMENTATION}" MATCHES "^OPENSSL$" AND OPENSSL_FOUND)
 
     CONFIGURE_FILE(${CMAKE_CURRENT_SOURCE_DIR}/build/cmake/config.h.in
