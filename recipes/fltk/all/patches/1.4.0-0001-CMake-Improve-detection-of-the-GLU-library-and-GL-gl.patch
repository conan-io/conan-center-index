From 123d5770a04ae029d6e67876a2f712551c214d45 Mon Sep 17 00:00:00 2001
From: Jordan Williams <jordan@jwillikers.com>
Date: Wed, 10 Apr 2024 14:52:03 -0500
Subject: [PATCH] CMake: Improve detection of the GLU library and GL/glu.h
 header file

---
 CMake/options.cmake | 7 +++++--
 src/CMakeLists.txt  | 3 +++
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/CMake/options.cmake b/CMake/options.cmake
index d04431ba7..c4ba98914 100644
--- a/CMake/options.cmake
+++ b/CMake/options.cmake
@@ -613,9 +613,11 @@ if(FLTK_BUILD_GL)
     set(OPENGL_FOUND TRUE)
     find_library(OPENGL_LIB GL)
     get_filename_component(PATH_TO_GLLIB ${OPENGL_LIB} DIRECTORY)
+    find_library(GLU_LIB GLU)
+    get_filename_component(PATH_TO_GLULIB ${GLU_LIB} DIRECTORY)
     # FIXME: we should find a better way to resolve this issue:
     # with GL, must use XQuartz libX11 else "Insufficient GL support"
-    set(OPENGL_LIBRARIES -L${PATH_TO_GLLIB} -lX11 -lGLU -lGL)
+    set(OPENGL_LIBRARIES -L${PATH_TO_GLULIB} -L${PATH_TO_GLLIB} -lX11 -lGLU -lGL)
     unset(HAVE_GL_GLU_H CACHE)
     find_file(HAVE_GL_GLU_H GL/glu.h PATHS ${X11_INCLUDE_DIR})
   else()
@@ -638,7 +640,8 @@ mark_as_advanced(OPENGL_LIB) # internal cache variable, not relevant for users
 mark_as_advanced(HAVE_GL_GLU_H)
 
 if(OPENGL_FOUND)
-  set(CMAKE_REQUIRED_INCLUDES ${OPENGL_INCLUDE_DIR}/GL)
+  find_path(OPENGL_GLU_INCLUDE_DIR NAMES GL/glu.h OpenGL/glu.h HINTS ${OPENGL_INCLUDE_DIR} ${X11_INCLUDE_DIR})
+  set(CMAKE_REQUIRED_INCLUDES ${OPENGL_INCLUDE_DIR}/GL ${OPENGL_GLU_INCLUDE_DIR})
 
   # Set GLLIBS (used in fltk-config).
   # We should probably deduct this from OPENGL_LIBRARIES but it turned
diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index 58954c2ca..e283f0ce4 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -813,6 +813,7 @@ endif()
 if(FLTK_USE_GL)
   fl_add_library(fltk_gl STATIC "${GLCPPFILES};${GL_HEADER_FILES};${GL_DRIVER_HEADER_FILES}")
   target_link_libraries(fltk_gl PUBLIC ${OPENGL_LIBRARIES} fltk::fltk)
+  target_include_directories(fltk_gl PUBLIC ${OPENGL_GLU_INCLUDE_DIR})
 endif(FLTK_USE_GL)
 
 #######################################################################
@@ -879,6 +880,7 @@ if(FLTK_BUILD_SHARED_LIBS AND NOT MSVC)
   if(FLTK_USE_GL)
     fl_add_library(fltk_gl SHARED "${GLCPPFILES};${GL_HEADER_FILES};${GL_DRIVER_HEADER_FILES}")
     target_link_libraries(fltk_gl-shared PUBLIC ${OPENGL_LIBRARIES} fltk::fltk-shared)
+    target_include_directories(fltk_gl-shared PUBLIC ${OPENGL_GLU_INCLUDE_DIR})
   endif(FLTK_USE_GL)
 
 endif(FLTK_BUILD_SHARED_LIBS AND NOT MSVC)
@@ -918,6 +920,7 @@ if(FLTK_BUILD_SHARED_LIBS AND MSVC)
 
   if(OPENGL_FOUND)
     target_link_libraries(fltk-shared PUBLIC ${OPENGL_LIBRARIES})
+    target_include_directories(fltk-shared PUBLIC ${OPENGL_GLU_INCLUDE_DIR})
   endif(OPENGL_FOUND)
 
 endif(FLTK_BUILD_SHARED_LIBS AND MSVC)
-- 
2.44.0

