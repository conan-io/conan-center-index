From 2f7218b8cd563e01a136577e77f7b89274f88f1d Mon Sep 17 00:00:00 2001
From: Jordan Williams <jordan@jwillikers.com>
Date: Mon, 22 Apr 2024 08:54:59 -0500
Subject: [PATCH 04/21] meson: Add build-blkdiscard option

Signed-off-by: Jordan Williams <jordan@jwillikers.com>
(cherry picked from commit b6741a82739f777b2eaf57563fd187ede42c6f1d)
---
 meson.build       | 16 +++++++++++-----
 meson_options.txt |  2 ++
 2 files changed, 13 insertions(+), 5 deletions(-)

diff --git a/meson.build b/meson.build
index ec4aec4597..6b276d88fc 100644
--- a/meson.build
+++ b/meson.build
@@ -1578,6 +1578,9 @@ if opt and not is_disabler(exe)
   bashcompletions += ['fsfreeze']
 endif
 
+have_linux_fs_h = cc.has_header('linux/fs.h')
+
+opt = get_option('build-blkdiscard').require(have_linux_fs_h).allowed()
 exe = executable(
   'blkdiscard',
   blkdiscard_sources,
@@ -1585,12 +1588,15 @@ exe = executable(
   link_with : [lib_common],
   dependencies : [blkid_dep],
   install_dir : sbindir,
-  install : true)
-exes += exe
-manadocs += ['sys-utils/blkdiscard.8.adoc']
-bashcompletions += ['blkdiscard']
+  install : opt,
+  build_by_default : opt)
+if opt and not is_disabler(exe)
+  exes += exe
+  manadocs += ['sys-utils/blkdiscard.8.adoc']
+  bashcompletions += ['blkdiscard']
+endif
 
-opt = get_option('build-blkzone').require(cc.has_header('linux/blkzoned.h')).allowed()
+opt = get_option('build-blkzone').require(have_linux_fs_h).allowed()
 exe = executable(
   'blkzone',
   blkzone_sources,
diff --git a/meson_options.txt b/meson_options.txt
index 930e96bd3a..c91a1cbfde 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -143,6 +143,8 @@ option('build-dmesg', type : 'feature',
        description : 'build dmesg')
 option('build-fsfreeze', type : 'feature',
        description : 'build fsfreeze')
+option('build-blkdiscard', type : 'feature',
+       description : 'build blkdiscard')
 option('build-blkzone', type : 'feature',
        description : 'build blkzone')
 option('build-blkpr', type : 'feature',
-- 
2.44.0

