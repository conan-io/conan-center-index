From 8cd1edaecd7d5f0536076fa61d8ba3c02b6c5c03 Mon Sep 17 00:00:00 2001
From: Jordan Williams <jordan@jwillikers.com>
Date: Mon, 22 Apr 2024 08:51:23 -0500
Subject: [PATCH 03/21] meson: Add build-fsfreeze option

Signed-off-by: Jordan Williams <jordan@jwillikers.com>
(cherry picked from commit dc3454c86b51f83fea27f22a98902a1ed64b9f78)
---
 meson.build       | 12 ++++++++----
 meson_options.txt |  2 ++
 2 files changed, 10 insertions(+), 4 deletions(-)

diff --git a/meson.build b/meson.build
index 801f289067..ec4aec4597 100644
--- a/meson.build
+++ b/meson.build
@@ -1564,15 +1564,19 @@ exes += exe
 manadocs += ['sys-utils/ctrlaltdel.8.adoc']
 bashcompletions += ['ctrlaltdel']
 
+opt = get_option('build-fsfreeze').require(cc.has_header('linux/fs.h')).allowed()
 exe = executable(
   'fsfreeze',
   fsfreeze_sources,
   include_directories : includes,
   install_dir : sbindir,
-  install : true)
-exes += exe
-manadocs += ['sys-utils/fsfreeze.8.adoc']
-bashcompletions += ['fsfreeze']
+  install : opt,
+  build_by_default : opt)
+if opt and not is_disabler(exe)
+  exes += exe
+  manadocs += ['sys-utils/fsfreeze.8.adoc']
+  bashcompletions += ['fsfreeze']
+endif
 
 exe = executable(
   'blkdiscard',
diff --git a/meson_options.txt b/meson_options.txt
index 862df4e917..930e96bd3a 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -141,6 +141,8 @@ option('build-fstrim', type : 'feature',
        description : 'build fstrim')
 option('build-dmesg', type : 'feature',
        description : 'build dmesg')
+option('build-fsfreeze', type : 'feature',
+       description : 'build fsfreeze')
 option('build-blkzone', type : 'feature',
        description : 'build blkzone')
 option('build-blkpr', type : 'feature',
-- 
2.44.0

