# Preparing recipes for Conan 2.0

As you may know, [Conan 2.0-alpha is already
released](https://github.com/conan-io/conan/releases/tag/2.0.0-alpha1). Although Conan
Center Index will keep on running with Conan 1.X for a long time, we want to anticipate to
the migration and start making changes in recipes so that they are as much compatible as
possible with Conan 2.0 and make the change easier when the time comes. 

For more information about Conan 2.0 and things that change to respect to Conan 1.X,
please read the [migration guide](https://docs.conan.io/en/latest/conan_v2.html) in the
Conan documentation.

This document is a practical guide covering the necessary changes to Conan Center Index
recipes to be ready to upgrade to Conan 2.0:

<!-- toc -->
## Contents

  * [Adding cpp_info set_property](#new-cpp_info-set_property-model)
    * [The Build Service](#the-build-service)<!-- endToc -->

## New cpp_info set_property model

New Conan generators, like
[CMakeDeps](https://docs.conan.io/en/latest/reference/conanfile/tools/cmake/cmakedeps.html)
and
[PkgConfigDeps](https://docs.conan.io/en/latest/reference/conanfile/tools/gnu/pkgconfigdeps.html)
don't listen to *cpp_info* ``.names``, ``.filenames`` or ``.build_modules`` attributes.
There is a new way of setting the *cpp_info* information for consumers that use these
generators via the ``set_property(property_name, value)`` method.

This means that all the information in the recipes that was set with the legacy model
should be translated to the new model. These two models **will live together in recipes** to
make recipes compatible **with both new and legacy generators** for some time. After an stable Conan 2.0
version is released and when the moment arrives that we don't support legacy generators
any more in Conan Center Index, the ``.names``, ``.filenames`` or ``.build_modules``
attributes will be removed and only ``set_property`` methods will remain.

We will cover different practical cases of porting all the information set with legacy
model to the new one. If you want to read more about the properties available for each
generator and how the new properties model work, please check the [Conan
documentation](https://docs.conan.io/en/latest/conan_v2.html#editables-don-t-use-external-templates-any-more-new-layout-model).

> ⚠️ **Note**: Please, remember that the **new** ``set_property`` and the **legacy** attributes
> model are *completely independent since Conan 1.43*. Setting ``set_property`` in recipes will
> not affect legacy generators (``cmake``, ``cmake_multi``, ``cmake_find_package`` and
> ``cmake_find_package_multi``) at all.

### Update required_conan_version to ">=1.43.0"

If you are setting the property ``cmake_target_name`` in the recipe, the Conan minimum
required version should be updated to 1.43. 

```python

required_conan_version = ">=1.43.0"

class GdalConan(ConanFile):
    name = "gdal"
    ...
```

The reason is that before Conan 1.43 the
``cmake_target_name`` values were interpreted as a part of the names of the targets for
CMake and Conan added namespaces automatically to these target names. After 1.43
``cmake_target_name`` sets the **complete target name** that is added to the ``.cmake`` files
generated by Conan. Let's see an example:

```python
class GdalConan(ConanFile):
    name = "gdal"
    ...
    def package_info(self):
        # Before 1.43 -> Conan adds GDAL:: namespace -> Creates target with name GDAL::GDAL
        self.cpp_info.set_property("cmake_target_name", "GDAL")

        # After 1.43 -> Conan creates target with name GDAL::GDAL
        self.cpp_info.set_property("cmake_target_name", "GDAL::GDAL")
```

### Translating .names information to cmake_target_name and cmake_file_name

To understand how to translate the ``.names`` information to the new model there are two
important things to take into account:

* The value of the ``.names`` attribute value in recipes is just a part of the final
  target name for CMake generators. Conan will complete the rest of the target name by
  pre-pending a namespace ending with ``::`` to the ``.names`` value. This namespace takes
  the same value as the ``.names`` value. Let's see an example: 

```python
class SomePkgConan(ConanFile):
    name = "somepkg"
    ...
    def package_info(self):
        self.cpp_info.names["cmake_find_package"] = "some-pkg"
        self.cpp_info.names["cmake_find_package_multi"] = "some-pkg"
        ...
```

This recipe generates the target ``some-pkg::some-pkg`` for both the
``cmake_find_package`` and the ``cmake_find_package_multi`` generators. Also, please
remember that if no ``.names`` attribute were set, Conan would create the target
``somepkg::somepkg`` for both generators by default.

As we explained before, the ``cmake_target_name`` sets the **complete target name**, so, 
to translate this information to the new model we should add the following lines:

```python
class SomePkgConan(ConanFile):
    name = "somepkg"
    ...
    def package_info(self):
        self.cpp_info.names["cmake_find_package"] = "some-pkg"
        self.cpp_info.names["cmake_find_package_multi"] = "some-pkg"
        # CMakeDeps does NOT add any namespace automatically
        self.cpp_info.set_property("cmake_target_name", "some-pkg::some-pkg") 
        ...
```

* Also, please bear in mind that the ``.names`` attribute can affect both the generated
  CMake target names and the filenames of the ``Find<pkg>.cmake`` or
  ``<pkg>-config.cmake`` files that store the dependencies information. That is because if
  the ``.filenames`` attribute is not set it will fall back on the ``.names`` value to
  generate the files. For the previous example, in order to translate all the information
  from the legacy model to the new one, we should have added one more line setting the
  ``cmake_file_name`` value.

```python
class SomePkgConan(ConanFile):
    name = "somepkg"
    ...
    def package_info(self):
        # Legacy generators fallback the filenames for the .cmake files
        # in the .names attribute value and generate 
        self.cpp_info.names["cmake_find_package"] = "some-pkg" # generates module file Findsome-pkg.cmake
        self.cpp_info.names["cmake_find_package_multi"] = "some-pkg" # generates config file some-pkg-config.cmake

        self.cpp_info.set_property("cmake_target_name", "some-pkg::some-pkg") 
        self.cpp_info.set_property("cmake_file_name", "some-pkg") # generates config file some-pkg-config.cmake
        ...
```

Please note that if we hadn't set the ``cmake_file_name`` property, the ``CMakeDeps`` generator would have taken the package name to generate the filename for the config file and the generated file would have been ``somepkg-config.cmake`` instead of ``some-pkg-config.cmake``.

### Translating .filenames information

### Set cmake_find_mode to both

### Testing CMakeDeps and PkgConfigDeps in Conan Center Index recipes

