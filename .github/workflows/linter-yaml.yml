name: "[linter] YAML files"

on:
  pull_request:

env:
  PYTHONPATH: ${{github.workspace}}
  PYVER: "3.8"
  CONFIG_FILES_PATH: "recipes/*/config.yml"
  CONANDATA_FILES_PATH: "recipes/*/*/conandata.yml"

jobs:
  test_linter:
    # A job to run when the linter changes. We want to know in advance how many files will be broken
    name: Test linter changes (YAML files)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Get changed files
        uses: tj-actions/changed-files@v20
        id: changed_files
        with:
          files: |
            linter/**

      - name: validate conandata files
        uses: ./.github/actions/yml_validation
        if: steps.changed_files.outputs.any_changed == 'true'
        with:
          python_version: ${{ env.PYVER }}
          files: ${{ env.CONANDATA_FILES_PATH }}
          python_linter: linter/conandata_yaml_linter.py

      - name: validate config files
        uses: ./.github/actions/yml_validation
        if: steps.changed_files.outputs.any_changed == 'true'
        with:
          python_version: ${{ env.PYVER }}
          files: ${{ env.CONFIG_FILES_PATH }}
          python_linter: linter/config_yaml_linter.py

  lint_pr_files:
    # Lint files modified in the pull_request
    name: Lint changed files (YAML files)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2

      ## Work on config.yml files
      - name: Get changed files (config)
        id: changed_files_config
        if: always()
        uses: tj-actions/changed-files@v20
        with:
          files: |
            ${{ env.CONFIG_FILES_PATH }}

      - name: validate config files
        uses: ./.github/actions/yml_validation
        if: steps.changed_files.outputs.any_changed == 'true'
        with:
          python_version: ${{ env.PYVER }}
          files: ${{ steps.changed_files_config.outputs.all_changed_files }}
          python_linter: linter/config_yaml_linter.py

      ## Work on conandata.yml files
      - name: Get changed files (conandata)
        id: changed_files_conandata
        if: always()
        uses: tj-actions/changed-files@v20
        with:
          files: |
            ${{ env.CONANDATA_FILES_PATH }}

      - name: validate conandata files
        uses: ./.github/actions/validation
        if: steps.changed_files.outputs.any_changed == 'true'
        with:
          python_version: ${{ env.PYVER }}
          files: ${{ steps.changed_files_conandata_outputs.all_changed_files }}
          python_linter: linter/conandata_yaml_linter.py
